<script>
        // ==========================================
        // CONFIGURA√á√ïES GERAIS
        // ==========================================
        
        // Supabase
        const SUPABASE_URL = 'https://nekbbkenxcukoortusge.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5la2Jia2VueGN1a29vcnR1c2dlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMzOTU5MDIsImV4cCI6MjA3ODk3MTkwMn0.D72914Vyz1du1ZDKoNDdwT7YI-D8WPgZe38LbBV2bfc';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // Admin
        const ADMIN_PASSWORD = "admin123";
        
        // PagSeguro (Token Sandbox)
        const PAGSEGURO_TOKEN = "2515675b-77f1-455e-8773-2af51ae659d2bf45c1ce4a328550ec306bdf219db647aada-7537-469e-8366-bd735c1a2caa";
        
        // VARI√ÅVEIS GLOBAIS (CORRE√á√ÉO DO ERRO AQUI)
        let pagseguroCheckout = null; // Declarada globalmente
        let selectedInstallments = 1;
        let cardType = 'credit'; 

        // ==========================================
        // FUN√á√ïES DO PAGSEGURO
        // ==========================================

        // Inicializar PagSeguro
        function initializePagSeguro() {
            try {
                if (typeof PagSeguro === 'undefined') {
                    console.error('‚ùå SDK do PagSeguro n√£o carregado no cabe√ßalho HTML');
                    return false;
                }
                
                // Atribui√ß√£o √† vari√°vel global
                pagseguroCheckout = PagSeguro.Checkout({
                    token: PAGSEGURO_TOKEN,
                    env: 'production' // Mude para 'production' quando for lan√ßar
                });
                
                console.log('‚úÖ PagSeguro inicializado e pronto para uso.');
                return true;
            } catch (error) {
                console.error('‚ùå Erro ao inicializar PagSeguro:', error);
                return false;
            }
        }

        // Processar pagamento com cart√£o
        async function processCardPayment() {
            // 1. Verifica√ß√£o de seguran√ßa do PagSeguro
            if (!pagseguroCheckout) {
                console.warn('PagSeguro n√£o estava pronto. Tentando inicializar agora...');
                initializePagSeguro();
                
                if (!pagseguroCheckout) {
                    alert('Erro t√©cnico: O sistema de pagamento n√£o p√¥de ser carregado. Por favor, recarregue a p√°gina e tente novamente.');
                    return;
                }
            }

            const nome = document.getElementById('nome').value;
            const email = document.getElementById('email').value;
            const telefone = document.getElementById('telefone').value;
            const produto = document.getElementById('produto').value;
            const valor = parseFloat(document.getElementById('valor').value);
            const mensagem = document.getElementById('mensagem').value;
            
            const cardNumber = document.getElementById('cardNumber').value;
            const cardHolder = document.getElementById('cardHolder').value;
            const cardExpiry = document.getElementById('cardExpiry').value;
            const cardCVC = document.getElementById('cardCVC').value;
            
            // Valida√ß√µes
            if (!nome || !email || !valor) {
                alert('Por favor, preencha todos os campos obrigat√≥rios (Nome, Email e Valor).');
                return;
            }
            
            const validationErrors = validateCard(cardNumber, cardHolder, cardExpiry, cardCVC);
            if (validationErrors.length > 0) {
                alert('Erros no cart√£o:\n\n' + validationErrors.join('\n'));
                return;
            }
            
            try {
                document.getElementById('paymentProcessing').style.display = 'block';
                
                // Preparar dados
                const paymentData = {
                    amount: (valor * 100).toFixed(0),
                    card: {
                        number: cardNumber.replace(/\s/g, ''),
                        holder: cardHolder,
                        exp_date: cardExpiry,
                        cvv: cardCVC
                    },
                    reference: `DONATION_${Date.now()}`,
                    sender: {
                        name: nome,
                        email: email,
                        phone: {
                            area_code: telefone ? telefone.replace(/\D/g, '').substring(0, 2) : '11',
                            number: telefone ? telefone.replace(/\D/g, '').substring(2) : '999999999'
                        }
                    },
                    items: [{
                        id: '1',
                        description: produto || 'Doa√ß√£o para Igreja',
                        amount: (valor * 100).toFixed(0),
                        quantity: 1
                    }]
                };
                
                if (cardType === 'credit') {
                    paymentData.installment = {
                        quantity: selectedInstallments,
                        value: (valor * 100 / selectedInstallments).toFixed(0)
                    };
                }
                
                // CHAMADA REAL DE PAGAMENTO
                const result = await pagseguroCheckout.payment({
                    method: cardType === 'credit' ? 'creditCard' : 'debitCard',
                    amount: paymentData.amount,
                    card: paymentData.card,
                    installment: paymentData.installment,
                    sender: paymentData.sender,
                    reference: paymentData.reference,
                    items: paymentData.items
                });
                
                console.log('‚úÖ Resultado:', result);
                
                if (result.errors) {
                    throw new Error(JSON.stringify(result.errors));
                }
                
                // Sucesso - Salvar no Banco
                await saveDonation(nome, email, telefone, produto, valor, mensagem, result.code || 'TRANSACAO_OK');
                
                document.getElementById('paymentProcessing').style.display = 'none';
                alert(`‚úÖ Pagamento Aprovado!\nObrigado, ${nome}!\nTransa√ß√£o: ${result.code || 'Sucesso'}`);
                
                // Limpar form
                document.getElementById('donationForm').reset();
                
            } catch (error) {
                document.getElementById('paymentProcessing').style.display = 'none';
                console.error('‚ùå Erro:', error);
                alert('O PagSeguro recusou a transa√ß√£o ou houve um erro t√©cnico.\n\nDetalhe: ' + (error.message || error));
            }
        }

        // ==========================================
        // FUN√á√ïES AUXILIARES E DE INTERFACE
        // ==========================================

        async function saveDonation(nome, email, tel, prod, val, msg, txId) {
            const { error } = await supabase.from('doacoes').insert([{
                nome_doador: nome, 
                email_doador: email, 
                telefone_doador: tel,
                produto: prod, 
                valor: val, 
                mensagem: msg,
                metodo_pagamento: cardType === 'credit' ? 'credito' : 'debito',
                parcelas: selectedInstallments,
                status: 'pago',
                pagamento_id: txId,
                data_criacao: new Date().toISOString()
            }]);
            if (error) console.error('Erro ao salvar no banco:', error);
        }

        function validateCard(number, holder, expiry, cvc) {
            const errors = [];
            if (number.replace(/\s/g, '').length < 13) errors.push('N√∫mero do cart√£o inv√°lido');
            if (holder.trim().length < 3) errors.push('Nome inv√°lido');
            if (!/^(0[1-9]|1[0-2])\/([0-9]{2})$/.test(expiry)) errors.push('Data deve ser MM/AA');
            if (cvc.length < 3) errors.push('CVV inv√°lido');
            return errors;
        }

        // Formata√ß√£o de inputs
        document.getElementById('cardNumber').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            value = value.replace(/(\d{4})(?=\d)/g, '$1 ');
            e.target.value = value.substring(0, 19);
        });
        
        document.getElementById('cardExpiry').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length >= 2) value = value.substring(0, 2) + '/' + value.substring(2, 4);
            e.target.value = value.substring(0, 5);
        });
        
        document.getElementById('cardCVC').addEventListener('input', function(e) {
            e.target.value = e.target.value.replace(/\D/g, '').substring(0, 4);
        });

        // Atualizar parcelas
        function updateInstallmentOptions() {
            const valor = parseFloat(document.getElementById('valor').value);
            const container = document.getElementById('installmentOptions');
            if (!valor || valor <= 0) { container.innerHTML = ''; return; }
            
            let html = '';
            if (cardType === 'debit') {
                html = `<div class="installment-option selected" data-n="1"><div class="installment-quantity">1x</div><div>R$ ${valor.toFixed(2)}</div></div>`;
                selectedInstallments = 1;
            } else {
                for (let i = 1; i <= 12; i++) {
                    html += `<div class="installment-option ${i===1?'selected':''}" data-n="${i}"><div class="installment-quantity">${i}x</div><div>R$ ${(valor/i).toFixed(2)}</div></div>`;
                }
            }
            container.innerHTML = html;
            
            document.querySelectorAll('.installment-option').forEach(opt => {
                opt.addEventListener('click', function() {
                    document.querySelectorAll('.installment-option').forEach(o => o.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedInstallments = parseInt(this.getAttribute('data-n'));
                });
            });
        }

        // Inicializa√ß√£o da P√°gina
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Iniciando sistema...');
            
            // Inicia PagSeguro imediatamente
            initializePagSeguro();

            // Listeners
            document.getElementById('valor').addEventListener('input', updateInstallmentOptions);
            
            // Troca de Abas (Pix/Cart√£o)
            document.querySelectorAll('.payment-option').forEach(opt => {
                opt.addEventListener('click', function() {
                    document.querySelectorAll('.payment-option').forEach(o => o.classList.remove('active'));
                    this.classList.add('active');
                    if (this.dataset.method === 'pix') {
                        document.getElementById('pixCode').style.display = 'block';
                        document.getElementById('cardForm').classList.remove('active');
                    } else {
                        document.getElementById('pixCode').style.display = 'none';
                        document.getElementById('cardForm').classList.add('active');
                    }
                });
            });

            // Troca Cr√©dito/D√©bito
            document.querySelectorAll('.payment-type-option').forEach(opt => {
                opt.addEventListener('click', function() {
                    document.querySelectorAll('.payment-type-option').forEach(o => o.classList.remove('active'));
                    this.classList.add('active');
                    cardType = this.dataset.type;
                    const selector = document.getElementById('installmentSelector');
                    if (cardType === 'credit') selector.classList.add('active');
                    else { selector.classList.remove('active'); selectedInstallments = 1; }
                    updateInstallmentOptions();
                });
            });
            
            // Carregar produtos e admin (fun√ß√µes mantidas simplificadas para brevidade, adicione se necess√°rio)
            loadProducts();
            
            // Bot√µes de Admin
             document.getElementById('adminLink').addEventListener('click', (e) => {
                e.preventDefault();
                document.getElementById('adminLogin').scrollIntoView({behavior:'smooth'});
            });
        });

        // Fun√ß√µes de Admin e Produtos (Mantidas do original para garantir funcionamento)
        async function loadProducts() {
            const grid = document.getElementById('productsGrid');
            try {
                const { data } = await supabase.from('produtos').select('*').eq('ativo', true);
                if(data && data.length > 0) {
                    grid.innerHTML = '';
                    data.forEach(p => {
                        grid.innerHTML += `
                        <div class="product-card">
                            <div class="product-image"><img src="${p.imagem_url || 'https://placehold.co/300'}" /></div>
                            <div class="product-info">
                                <h3>${p.nome}</h3>
                                <p>${p.descricao}</p>
                                <div class="product-price">R$ ${p.preco}</div>
                                <button class="btn" onclick="selectProduct('${p.nome}', ${p.preco})">Selecionar</button>
                            </div>
                        </div>`;
                    });
                } else { grid.innerHTML = '<p>Sem produtos no momento.</p>'; }
            } catch(e) { grid.innerHTML = '<p>Erro ao carregar.</p>'; }
        }

        function selectProduct(nome, val) {
            document.getElementById('produto').value = nome;
            document.getElementById('valor').value = val;
            document.getElementById('doacao').scrollIntoView({behavior:'smooth'});
            updateInstallmentOptions();
        }

        function loginAdmin() {
            if(document.getElementById('adminPassword').value === ADMIN_PASSWORD) {
                document.getElementById('adminLogin').classList.remove('active');
                document.getElementById('adminPanel').classList.add('active');
                loadAdminProducts();
            } else alert('Senha incorreta');
        }
        
        function logoutAdmin() {
             document.getElementById('adminPanel').classList.remove('active');
             document.getElementById('adminLogin').classList.add('active');
        }

        // Fun√ß√µes auxiliares de Admin (Carregar e Deletar)
        async function loadAdminProducts() {
            const grid = document.getElementById('adminProductsGrid');
            const { data } = await supabase.from('produtos').select('*');
            grid.innerHTML = '';
            if(data) data.forEach(p => {
                grid.innerHTML += `<div class="admin-product-card">
                    <h4>${p.nome}</h4>
                    <button class="btn btn-danger btn-small" onclick="deleteProduct(${p.id})">Excluir</button>
                </div>`;
            });
        }
        
        async function deleteProduct(id) {
            if(confirm('Deletar?')) {
                await supabase.from('produtos').delete().eq('id', id);
                loadAdminProducts();
                loadProducts();
            }
        }
        
        // Upload e Submit de Produto (Simplificado)
        document.getElementById('productForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const file = document.getElementById('productImage').files[0];
            let url = null;
            if(file) {
                const path = `produtos/${Date.now()}_${file.name}`;
                await supabase.storage.from('imagens2').upload(path, file);
                const { data } = supabase.storage.from('imagens2').getPublicUrl(path);
                url = data.publicUrl;
            }
            await supabase.from('produtos').insert([{
                nome: document.getElementById('productName').value,
                descricao: document.getElementById('productDescription').value,
                preco: document.getElementById('productPrice').value,
                imagem_url: url,
                ativo: true
            }]);
            alert('Produto salvo!');
            document.getElementById('productForm').reset();
            loadAdminProducts();
            loadProducts();
        });

        // Pix confirm
        async function confirmPayment() {
            await saveDonation(
                document.getElementById('nome').value,
                document.getElementById('email').value,
                document.getElementById('telefone').value,
                document.getElementById('produto').value,
                document.getElementById('valor').value,
                document.getElementById('mensagem').value,
                'PIX_PENDENTE'
            );
            alert('Doa√ß√£o PIX registrada! Aguardando confirma√ß√£o.');
        }
    </script>
